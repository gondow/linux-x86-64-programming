<style type="text/css">
body { counter-reset: chapter 3; }
</style>

# x86-64機械語命令

## x86-64機械語命令の実行方法{#how-to-execute-x86-inst}

### 概要

機械語命令を実行しても，単に`a.out`を実行するだけでは
意図通りに実行できたかの確認が難しいです．
(アセンブリコード内から`printf`を呼び出せばいいのですが，
そのコードもうざいので)．
そこで本書では**デバッガを使って**機械語命令の実行と確認を行います．

以下では例として`movq $999, %rax`という機械語命令を実行してみます．
(これらのファイルは[サンプルコード](https://github.com/gondow/linux-x86-64-programming/tree/main/src/asm)から入手できます)．

```x86asmatt
{{#include asm/movq-4.s}}
```

実行確認のための`gdb`のコマンド列を書いたファイルも用意しています．

<div id="asm/movq-4.txt">

```
# asm/movq-4.txt
{{#include asm/movq-4.txt}}
```
</div>

### デバッガ上で実行：`gdb`コマンドを手入力

`asm/movq-4.txt`中の`gdb`コマンドを
以下のように1行ずつ入力してみて下さい．

```nohighlight
$ gcc -g movq-4.s
$ gdb ./a.out ❶
(gdb) b 7 ❷
Breakpoint 1 at 0x1130: file movq-4.s, line 6.
(gdb) r ❸
Breakpoint 1, main () at movq-4.s:6
6	    ret
(gdb) list 6,6 ❹
5	    movq $999, %rax
(gdb) p $rax ❺
$1 = 999
(gdb) quit
```

- ❶ コンパイルした`a.out`を`gdb`上で実行
- ❷ ブレークポイントを7行目(`movq $999, %rax`の次の行)に設定
- ❸ 実行開始
- ❹ ソースコードの6行目だけを表示
- ❺ レジスタ`%rax`の値を(10進表記で)表示
- [`movq-4.txt`](#asm/movq-4.txt)
  の最後の行 `echo # %raxの値が999なら成功\n`は，
  「どうなると正しく実行できたか」を確認するメッセージですので，
  ここでは入力不要です．
  ❺の結果と一致したので「正しい実行」と確認できました．

### デバッガ上で実行：`gdb`コマンドを自動入力 (`-x`オプションを使う)

`gdb`コマンドを手入力して，よく使う`gdb`コマンドを覚えることは良いことです．
とはいえ，手入力は面倒なので，自動入力も可能です．

```nohighlight
$ gcc -g movq-4.s
$ gdb ./a.out ❶ -x movq-4.txt
Breakpoint 1, main () at movq-4.s:7
7	    ret
6	 ❷ movq $999, %rax
❸ $1 = 999 
❹ # %raxの値が999なら成功
(gdb) 

```

- ❶ `-x movq-4.txt` というオプションをつけると，指定したファイル(ここでは`movq-4.txt`)の中に書かれている`gdb`コマンドを1行ずつ順番に実行してくれます
-  `list 6,6`を実行した結果，❷6行目の`movq $999, %rax` が表示されています
-  `p $rax`を実行した結果，`%rax`レジスタの値が❸999であると表示されています．
  (`$1`は`gdb`が扱う変数です．ここでは無視して下さい)
-  `echo # %raxの値が999なら成功\n` を`gdb`が実行した結果，
❹ `# %raxの値が999なら成功`というメッセージが表示されています．
このメッセージと❸の実行結果を見比べれば「実行結果が正しい」ことを確認できます．

### デバッガ上で実行：`gdb`コマンドを自動入力 (`source`コマンドを使う)

```nohighlight
$ gcc -g movq-4.s
$ gdb ./a.out
(gdb) ❶ source movq-4.txt
Breakpoint 1, main () at movq-4.s:7
7	    ret
6	    movq $999, %rax
$1 = 999
# %raxの値が999なら成功
```

`gdb`は通常通りに実行開始して，
❶ `source`コマンドを使えば，`movq-4.txt`中の`gdb`コマンドを実行できます．
`-x`オプションと`source`コマンドは好きな方を使って下さい．

## アドレッシングモード (オペランドの表記方法)

### メモリ参照

## x86-64機械語命令 (転送など)
## x86-64機械語命令 (算術論理演算)
### 四則演算
### インクリメント，デクリメント，符号反転
### ビット論理演算
### シフト演算
### ローテート演算
## x86-64機械語命令 (比較とジャンプ)
### 比較
### 無条件ジャンプ
### 条件付きジャンプ

## x86-64機械語命令 (関数呼び出しとリターン)

### `call`
