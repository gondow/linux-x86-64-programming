<!DOCTYPE HTML>
<html lang="ja" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>アセンブラ命令 0% - Linuxで学ぶx86-64アセンブリ言語</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="この本は書きかけですが，ご意見は歓迎します">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

	<!-- Tab -->
        <link rel="stylesheet" href="css/tab.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/pagetoc.css">
        <link rel="stylesheet" href="theme/tab.css">

        <!-- MathJax -->
        <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
-->
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">準備</li><li class="chapter-item "><a href="1-pre.html"><strong aria-hidden="true">1.</strong> 前書き</a></li><li class="chapter-item affix "><li class="part-title">概要</li><li class="chapter-item "><a href="2-asm-intro.html"><strong aria-hidden="true">2.</strong> アセンブリ言語の概要 90%</a></li><li class="chapter-item "><a href="3-binary.html"><strong aria-hidden="true">3.</strong> バイナリファイル 90%</a></li><li class="chapter-item affix "><li class="part-title">より詳しい説明</li><li class="chapter-item "><a href="5-arch.html"><strong aria-hidden="true">4.</strong> コンピュータアーキテクチャの基本：CPU，メモリ，レジスタなど 90%</a></li><li class="chapter-item "><a href="4-data.html"><strong aria-hidden="true">5.</strong> データ表現，2進数，2の補数 90%</a></li><li class="chapter-item "><a href="6-inst.html"><strong aria-hidden="true">6.</strong> x86-64機械語命令 90%</a></li><li class="chapter-item expanded "><a href="7-asm.html" class="active"><strong aria-hidden="true">7.</strong> アセンブラ命令 0%</a></li><li class="chapter-item "><a href="8-inline.html"><strong aria-hidden="true">8.</strong> インラインアセンブラ 0%</a></li><li class="chapter-item "><a href="9-abi.html"><strong aria-hidden="true">9.</strong> ABI: アプリケーション・バイナリ・インタフェース 0%</a></li><li class="chapter-item "><a href="10-gdb.html"><strong aria-hidden="true">10.</strong> デバッガgdbの使い方 90%</a></li><li class="chapter-item "><div><strong aria-hidden="true">11.</strong> gccが生成したアセンブリコードを読む</div></li><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">リファレンス</li><li class="chapter-item "><a href="x86-list.html"><strong aria-hidden="true">12.</strong> x86-64命令一覧 80%</a></li><li class="chapter-item "><a href="links.html"><strong aria-hidden="true">13.</strong> リンク集 10%</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Linuxで学ぶx86-64アセンブリ言語</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
		    <main><div class="sidetoc"><nav class="pagetoc"></nav></div>
		      <style type="text/css">
body { counter-reset: chapter 7; }
</style>
<h1 id="アセンブラ命令"><a class="header" href="#アセンブラ命令">アセンブラ命令</a></h1>
<h3 id="アセンブラとアセンブラ命令"><a class="header" href="#アセンブラとアセンブラ命令">アセンブラとアセンブラ命令</a></h3>
<ul>
<li><strong>アセンブラ</strong> (assembler)はアセンブリコード (<code>foo.s</code>)を
オブジェクトファイル (<code>foo.o</code>)に変換するプログラムです．
<ul>
<li>例えば，<code>gcc -c foo.s</code>とするとアセンブルできます．
<code>gcc -c</code>は内部で<code>as</code>コマンドを呼んでいて，これがアセンブラ本体です．
(<code>gcc</code>に<code>-v</code>オプションを付けると，<code>as</code>コマンドの実行が見えます)．</li>
</ul>
</li>
<li><strong>アセンブラ命令</strong> (assembler directive)はアセンブラへの指示です．
<ul>
<li>例えば，<code>.text</code>はアセンブラに「出力先を<code>.text</code>セクションに切り替えろ」と
指示しています．</li>
<li>GNUアセンブラのアセンブラ命令は<strong>すべてドット</strong><code>.</code>で始まります．</li>
</ul>
</li>
<li>アセンブラ命令はCPUが実行しない命令なので，
<strong>疑似命令</strong>(psuedo instruction)とも呼ばれます．
(が，分かりにくい用語なので本書では使いません)．</li>
</ul>
<h3 id="アセンブラ命令と機械語命令"><a class="header" href="#アセンブラ命令と機械語命令">アセンブラ命令と機械語命令</a></h3>
<div class="table-wrapper"><table><thead><tr><th></th><th>例</th><th>何が実行</th><th>いつ実行</th><th>バイナリファイル中に</th></tr></thead><tbody>
<tr><td>アセンブラ命令</td><td><code>.text</code></td><td>アセンブラ</td><td>アセンブル時</td><td>残らない</td></tr>
<tr><td>機械語命令</td><td><code>addl $5, %eax</code></td><td>CPU</td><td><code>a.out</code>実行時</td><td>残る</td></tr>
</tbody></table>
</div><img src="figs/add5-2.svg" height="200px" id="fig:add5-2">
<ul>
<li>アセンブラがアセンブリコード(<code>*.s</code>)からオブジェクトファイル(<code>*.o</code>)を作る際に，
<ul>
<li>アセンブラ命令(例: <code>.text</code>)に従って処理をします．例えば，<code>addl $5, %eax</code>を
バイト列に変換した結果 <code>0x83 0xC0 0x05</code>を<code>.text</code>セクションに出力します．</li>
<li>その結果，アセンブラ命令 <code>.text</code>はオブジェクトファイルには残りません．
(オブジェクトファイル中に<code>.text</code>セクションはありますが，
これはアセンブラ命令<code>.text</code>ではありません)．</li>
</ul>
</li>
<li>一方，機械語命令 <code>addl $5, %eax</code>はオブジェクトファイルに残っています
(バイト列 <code>0x83 0xC0 0x05</code>と見た目は変わっていますが)．
<code>a.out</code>を実行したときに，CPUがこの機械語命令を実行します．</li>
</ul>
<h2 id="アセンブラの主な仕事"><a class="header" href="#アセンブラの主な仕事">アセンブラの主な仕事</a></h2>
<h3 id="概要"><a class="header" href="#概要">概要</a></h3>
<p>アセンブラの主なお仕事は大きく次の4つです．</p>
<ul>
<li>
<p>機械語命令やデータを<a href="./4-data.html">2進数表現に変換</a>する</p>
<ul>
<li>例: <code>pushq %rax</code> を <code>0x50</code> に変換する</li>
<li>例: <code>.string &quot;%d\n&quot;</code> を <code>0x25 0x64 0x0A 0x00</code>に変換する
(<code>.string</code>は自動的に<strong>ヌル文字</strong> <code>0x00</code>を最後に付加します)</li>
<li>アセンブラにとって，機械語命令もデータも
「2進数にして出力する」という意味で，どちらも単なるデータです．</li>
</ul>
</li>
<li>
<p>変換した2進数を指定された<strong>セクション</strong>に出力する</p>
</li>
<li>
<p><strong>記号表</strong> (symbol table)を作って，ラベルをアドレスに変換する</p>
</li>
<li>
<p>最後に変換したデータをバイナリ形式(LinuxではELF形式)にしてファイル出力する</p>
</li>
</ul>
<h3 id="セクションへの出力"><a class="header" href="#セクションへの出力">セクションへの出力</a></h3>
<h4 id="セクションとは"><a class="header" href="#セクションとは">セクションとは</a></h4>
<p>バイナリファイルの構造はざっくり以下の図のようになっています．</p>
<img src="figs/section.svg" height="250px" id="fig:text-binary">
<ul>
<li>基本的に，バイナリ (オブジェクトファイル<code>*.o</code>や実行可能ファイル<code>a.out</code>)は
<strong>セクション</strong> (section)という単位で区切られていて，それぞれ別の目的でデータが格納されます．</li>
<li><strong>ヘッダ</strong> (header)は目次の役割で「どこにどんなセクションがあるか」という情報を保持しています．</li>
</ul>
<h4 id="代表的なセクション"><a class="header" href="#代表的なセクション">代表的なセクション</a></h4>
<div class="table-wrapper"><table><thead><tr><th>セクション名</th><th>説明</th></tr></thead><tbody>
<tr><td><code>.text</code></td><td>機械語命令(例：<code>pushq %rbp</code>)を置くセクション</td></tr>
<tr><td><code>.data</code></td><td>初期化済みの静的変数の値(例：<code>0x1234</code>)を置くセクション</td></tr>
<tr><td><code>.bss</code></td><td>未初期化(実行時に0で初期化する)の静的変数の値を置くセクション</td></tr>
<tr><td><code>.rodata</code></td><td>読み込みのみ(read only)の値(例：<code>&quot;hello\n&quot;</code>)を置くセクション</td></tr>
</tbody></table>
</div>
<h4 id="各セクションに出力する例"><a class="header" href="#各セクションに出力する例">各セクションに出力する例</a></h4>
<p>例えば，以下のアセンブリコード<code>foo.s</code>があるとします
(<code>.rodata</code>セクションを指定する際は，<code>.section</code>が必要です)．</p>
<pre><code class="language-x86asmatt"># foo.s
.text            # .textセクションに出力せよ
pushq %rbp
movq %rsp, %rbp
.data            # .dataセクションに出力せよ
.long 0x11223344
.section .rodata # .rodataセクションに出力せよ
.string &quot;hello\n&quot;
</code></pre>
<img src="figs/section2.svg" height="200px" id="fig:section2">
<p>この<code>foo.s</code>をアセンブラが処理すると以下になります．</p>
<ul>
<li><code>pushq %rbp</code>を2進数にすると <code>0x55</code>，
<code>movq %rsp, %rbp</code>を2進数にすると <code>0x48 0x89 0xe5</code> なので，
これら合計4バイトを<code>.text</code>セクションに出力します．</li>
<li><code>.data</code>は「<code>.data</code>セクションに出力せよ」
「<code>.long</code>は指定したデータを4バイトの2進数として出力せよ」という意味です．
<code>0x11223344</code>を2進数にすると <code>0x44 0x33 0x22 0x11</code>なので
これら4バイトを<code>.data</code>セクションに出力します．
(出力が逆順になっているように見えるのは
x86-64が<a href="./3-binary.html#%E3%83%AA%E3%83%88%E3%83%AB%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3">リトルエンディアン</a>だからです．)</li>
<li><code>.section .rodata</code>は「<code>.rodata</code>セクションに出力せよ」
「<code>.string</code>は指定した文字列をASCIIコードの2進数として出力せよ」という意味です．
<code>&quot;hello\n&quot;</code>を2進数にすると <code>0x68 0x65 0x6c 0x6c 0x64 0x0a 0x00</code>なので，
これら7バイトを<code>.rodata</code>セクションに出力します．
(最後の'\0'はヌル文字です．C言語では文字列定数の最後に自動的に
ヌル文字が追加されますが，アセンブリ言語では必ずしもそうではありません．
<code>.string</code>はヌル文字を自動的に追加します．
一方，(ここでは使っていませんが)<code>.ascii</code>はヌル文字を自動的に追加しません)．
ASCIIコードは<code>man ascii</code>で確認できます．</li>
</ul>
<h4 id="セクションを確認する"><a class="header" href="#セクションを確認する">セクションを確認する</a></h4>
<ul>
<li>
<p>セクションの内容は<code>objdump -h</code>や<code>readelf -S</code>コマンドで表示できます．</p>
</li>
<li>
<p><code>objdump -h</code> の例と読み方</p>
</li>
</ul>
<pre><code class="language-bash">$ gcc -g -c add5.c
$ objdump -h add5.o
add5.o:     file format elf64-x86-64

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
  0 .text         00000013  0000000000000000  0000000000000000  00000040  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  1 .data         00000000  0000000000000000  0000000000000000  00000053  2**0
                  CONTENTS, ALLOC, LOAD, DATA
  2 .bss          00000000  0000000000000000  0000000000000000  00000053  2**0
                  ALLOC
<span class="boring">  3 .debug_info   00000066  0000000000000000  0000000000000000  00000053  2**0
</span><span class="boring">                  CONTENTS, RELOC, READONLY, DEBUGGING, OCTETS
</span><span class="boring">  4 .debug_abbrev 0000004d  0000000000000000  0000000000000000  000000b9  2**0
</span><span class="boring">                  CONTENTS, READONLY, DEBUGGING, OCTETS
</span><span class="boring">  5 .debug_aranges 00000030  0000000000000000  0000000000000000  00000106  2**0
</span><span class="boring">                  CONTENTS, RELOC, READONLY, DEBUGGING, OCTETS
</span><span class="boring">  6 .debug_line   0000004f  0000000000000000  0000000000000000  00000136  2**0
</span><span class="boring">                  CONTENTS, RELOC, READONLY, DEBUGGING, OCTETS
</span><span class="boring">  7 .debug_str    00000093  0000000000000000  0000000000000000  00000185  2**0
</span><span class="boring">                  CONTENTS, READONLY, DEBUGGING, OCTETS
</span><span class="boring">  8 .debug_line_str 00000089  0000000000000000  0000000000000000  00000218  2**0
</span><span class="boring">                  CONTENTS, READONLY, DEBUGGING, OCTETS
</span><span class="boring">  9 .comment      0000002c  0000000000000000  0000000000000000  000002a1  2**0
</span><span class="boring">                  CONTENTS, READONLY
</span><span class="boring"> 10 .note.GNU-stack 00000000  0000000000000000  0000000000000000  000002cd  2**0
</span><span class="boring">                  CONTENTS, READONLY
</span><span class="boring"> 11 .note.gnu.property 00000020  0000000000000000  0000000000000000  000002d0  2**3
</span><span class="boring">                  CONTENTS, ALLOC, LOAD, READONLY, DATA
</span><span class="boring"> 12 .eh_frame     00000038  0000000000000000  0000000000000000  000002f0  2**3
</span><span class="boring">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA
</span></code></pre>
<div class="table-wrapper"><table><thead><tr><th>欄</th><th>例</th><th>説明</th></tr></thead><tbody>
<tr><td>Idx</td><td>1</td><td>セクションの通し番号</td></tr>
<tr><td>Name</td><td><code>.text</code></td><td>セクションの名前</td></tr>
<tr><td>Size</td><td><code>00000013</code></td><td>セクションのサイズ (16進数，バイト)</td></tr>
<tr><td>VMA</td><td><code>00000000</code></td><td>実行時のセクションのアドレス (virtual memory address, 16進数)</td></tr>
<tr><td>LMA</td><td><code>00000000</code></td><td>ロード時のセクションのアドレス (load memory address, 16進数)</td></tr>
<tr><td>File Off</td><td><code>00000040</code></td><td>ファイルオフセット(16進数，バイト)</td></tr>
<tr><td>Algn</td><td><code>2**0</code></td><td>セクションのアラインメント制約(バイト), <code>2**n</code>は\(2^n\)を意味</td></tr>
</tbody></table>
</div><br/>
<div class="table-wrapper"><table><thead><tr><th>属性</th><th>説明</th></tr></thead><tbody>
<tr><td>CONTENTS</td><td>このセクションには中身がある(つまり中身が空のセクションもある)</td></tr>
<tr><td>ALLOC</td><td>ロード時にこのセクションのためにメモリを割り当てる必要がある</td></tr>
<tr><td>LOAD</td><td>このセクションは実行するためにメモリ上にロードする必要がある</td></tr>
<tr><td>READONLY</td><td>メモリ上では「読み込みのみ許可(書き込み禁止)」と設定する必要がある</td></tr>
<tr><td>CODE</td><td>このセクションは実行可能な機械語命令を含んでいる</td></tr>
<tr><td>RELOC</td><td>このセクションは再配置情報を含んでいる</td></tr>
</tbody></table>
</div>
<ul>
<li><code>readelf -S</code> の例と読み方</li>
</ul>
<pre><code class="language-bash">$ gcc -g -c add5.c
$ readelf -S add5.o
There are 21 section headers, starting at offset 0x640:

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040
       0000000000000013  0000000000000000  AX       0     0     1
  [ 2] .data             PROGBITS         0000000000000000  00000053
       0000000000000000  0000000000000000  WA       0     0     1
  [ 3] .bss              NOBITS           0000000000000000  00000053
       0000000000000000  0000000000000000  WA       0     0     1
<span class="boring">  [ 4] .debug_info       PROGBITS         0000000000000000  00000053
</span><span class="boring">       0000000000000066  0000000000000000           0     0     1
</span><span class="boring">  [ 5] .rela.debug_info  RELA             0000000000000000  00000410
</span><span class="boring">       00000000000000c0  0000000000000018   I      18     4     8
</span><span class="boring">  [ 6] .debug_abbrev     PROGBITS         0000000000000000  000000b9
</span><span class="boring">       000000000000004d  0000000000000000           0     0     1
</span><span class="boring">  [ 7] .debug_aranges    PROGBITS         0000000000000000  00000106
</span><span class="boring">       0000000000000030  0000000000000000           0     0     1
</span><span class="boring">  [ 8] .rela.debug_[...] RELA             0000000000000000  000004d0
</span><span class="boring">       0000000000000030  0000000000000018   I      18     7     8
</span><span class="boring">  [ 9] .debug_line       PROGBITS         0000000000000000  00000136
</span><span class="boring">       000000000000004f  0000000000000000           0     0     1
</span><span class="boring">  [10] .rela.debug_line  RELA             0000000000000000  00000500
</span><span class="boring">       0000000000000060  0000000000000018   I      18     9     8
</span><span class="boring">  [11] .debug_str        PROGBITS         0000000000000000  00000185
</span><span class="boring">       0000000000000093  0000000000000001  MS       0     0     1
</span><span class="boring">  [12] .debug_line_str   PROGBITS         0000000000000000  00000218
</span><span class="boring">       0000000000000089  0000000000000001  MS       0     0     1
</span><span class="boring">  [13] .comment          PROGBITS         0000000000000000  000002a1
</span><span class="boring">       000000000000002c  0000000000000001  MS       0     0     1
</span><span class="boring">  [14] .note.GNU-stack   PROGBITS         0000000000000000  000002cd
</span><span class="boring">       0000000000000000  0000000000000000           0     0     1
</span><span class="boring">  [15] .note.gnu.pr[...] NOTE             0000000000000000  000002d0
</span><span class="boring">       0000000000000020  0000000000000000   A       0     0     8
</span><span class="boring">  [16] .eh_frame         PROGBITS         0000000000000000  000002f0
</span><span class="boring">       0000000000000038  0000000000000000   A       0     0     8
</span><span class="boring">  [17] .rela.eh_frame    RELA             0000000000000000  00000560
</span><span class="boring">       0000000000000018  0000000000000018   I      18    16     8
</span><span class="boring">  [18] .symtab           SYMTAB           0000000000000000  00000328
</span><span class="boring">       00000000000000d8  0000000000000018          19     8     8
</span><span class="boring">  [19] .strtab           STRTAB           0000000000000000  00000400
</span><span class="boring">       000000000000000d  0000000000000000           0     0     1
</span><span class="boring">  [20] .shstrtab         STRTAB           0000000000000000  00000578
</span><span class="boring">       00000000000000c6  0000000000000000           0     0     1
</span><span class="boring">Key to Flags:
</span><span class="boring">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
</span><span class="boring">  L (link order), O (extra OS processing required), G (group), T (TLS),
</span><span class="boring">  C (compressed), x (unknown), o (OS specific), E (exclude),
</span><span class="boring">  D (mbind), l (large), p (processor specific)
</span></code></pre>
<div class="table-wrapper"><table><thead><tr><th>欄</th><th>例</th><th>説明</th></tr></thead><tbody>
<tr><td>[Nr]</td><td>[1]</td><td>セクションの通し番号</td></tr>
<tr><td>Name</td><td><code>.text</code></td><td>セクションの名前</td></tr>
<tr><td>Type</td><td><code>PROGBITS</code></td><td>セクションのタイプ (以下参照)</td></tr>
<tr><td>Address</td><td><code>0000000000000000</code></td><td>セクションのアドレス</td></tr>
<tr><td>Offset</td><td><code>00000040</code></td><td>ファイルオフセット(16進数，バイト)</td></tr>
<tr><td>Size</td><td><code>0000000000000013</code></td><td>セクションのサイズ (16進数，バイト)</td></tr>
<tr><td>EntSize</td><td><code>0000000000000000</code></td><td>表中の固定長のエントリのサイズ (エントリがない場合は0)</td></tr>
<tr><td>Flags</td><td><code>AX</code></td><td>セクションのフラグ (以下参照)</td></tr>
<tr><td>Link</td><td><code>0</code></td><td>関連するセクションの通し番号([Nr]) (存在しない場合は0)</td></tr>
<tr><td>Info</td><td><code>0</code></td><td>関連情報 (ない場合は0)</td></tr>
<tr><td>Align</td><td><code>1</code></td><td>セクションのアラインメント制約(バイト)</td></tr>
</tbody></table>
</div><br/>
<div class="table-wrapper"><table><thead><tr><th>セクションのタイプ</th><th>説明</th></tr></thead><tbody>
<tr><td>NULL</td><td>このセクションは使われていない</td></tr>
<tr><td>PROGBITS</td><td>このセクションはプログラムがフォーマットと意味を決める情報を含む</td></tr>
<tr><td>NOBITS</td><td>未初期化の領域を含む (ファイル中ではサイズゼロ)</td></tr>
<tr><td>RELA</td><td>このセクションは再配置情報を含む (調整用の値(addend)を含む)</td></tr>
<tr><td>NOTE</td><td>言語処理系が定義・使用するメモ書き</td></tr>
<tr><td>SYMTAB</td><td>このセクションは記号表 (symbol table)</td></tr>
<tr><td>STRTAB</td><td>このセクションは文字列表 (string table)</td></tr>
</tbody></table>
</div><br/>
<div class="table-wrapper"><table><thead><tr><th>フラグ</th><th>説明</th></tr></thead><tbody>
<tr><td>W (write)</td><td>このセクションは実行時に書き込み可能にしておく必要がある</td></tr>
<tr><td>A (alloc)</td><td>ロード時にこのセクションのためにメモリを割り当てる必要がある</td></tr>
<tr><td>X (execute)</td><td>このセクションは実行可能な機械語命令を含む</td></tr>
<tr><td>M (merge)</td><td>このセクション中のデータは重複を避けるためにマージ可能</td></tr>
<tr><td>S (strings)</td><td>このセクションはヌル終端の文字列を含む</td></tr>
<tr><td>I (info)</td><td>このセクションはセクションのタイプに依存した付加情報を保持してる</td></tr>
<tr><td>L (link order)</td><td>このセクションはリンカに対して特別な順序を要求する</td></tr>
<tr><td>O (extra OS processing required)</td><td>このセクションはOS固有の特別な処理が必要である</td></tr>
<tr><td>G (group)</td><td>このセクションはセクショングループのメンバーである</td></tr>
<tr><td>T (TLS)</td><td>このセクションはスレッドローカルストレージを持つ</td></tr>
<tr><td>C (compressed)</td><td>このセクションの内容は圧縮されている (AやNOBITSとの併用はNG)</td></tr>
<tr><td>x (unknown)</td><td>このセクションは不明なセクションである</td></tr>
<tr><td>o (OS specific)</td><td>OS固有の意味を持つ</td></tr>
<tr><td>E (exclude)</td><td>このセクションは参照もメモリ割り当てもされなければ削除される</td></tr>
<tr><td>D (mbind)</td><td>このセクションは特別なメモリ領域に置く必要がある．Infoがそのメモリタイプを示す</td></tr>
<tr><td>l (large)</td><td>このセクションは(2GB以上の)largeコードモデルである</td></tr>
<tr><td>p (processor specific)</td><td>プロセッサ固有の意味を持つ</td></tr>
</tbody></table>
</div>
<ul>
<li><code>readelf -t</code> で，より詳細なセクション情報を表示可能</li>
<li><code>readelf -n</code>で<code>NOTE</code>セクションの内容を表示可能</li>
</ul>
<h3 id="記号表とアドレスへの変換"><a class="header" href="#記号表とアドレスへの変換">記号表とアドレスへの変換</a></h3>
<pre><code class="language-x86asmatt"># sym-main.s
	.text
	.globl	main
	.type	main, @function
main:
	movl	x(%rip), %eax # ラベル x の参照
	ret
	.size	main, .-main
</code></pre>
<pre><code class="language-x86asmatt"># sym-sub.s
	.globl	x
	.data
	.align 4
	.type	x, @object
	.size	x, 4
x:                     # ラベル x の定義
	.long	999
</code></pre>
<pre><code>$ gcc -c sym-main.s
$ gcc -c sym-sub.s
$ gcc sym-main.o sym-sub.o
$ nm sym-main.o
0000000000000000 T main
              ❶ U x
$ nm sym-sub.o
❷ 0000000000000000 D x 
$ nm a.out | egrep ' x'
❸ 0000000000004010 D x

$ objdump -D ./a.out
0000000000001129 &lt;main&gt;:
    1129: 8b 05 e1 2e 00 00    	mov  ❹ 0x2ee1(%rip),%eax  # 4010 &lt;x&gt;
 ❻ 112f: c3                   	ret    
(中略)
0000000000004010 &lt;x&gt;:
 ❺ 4010: e7 03                 out    %eax,$0x3
$ bc
obase=16
ibase=16
4010-112F
❼ 2EE1
</code></pre>
<ul>
<li><strong>アセンブラは記号表を作り</strong>，ラベルを見つけるたびに記号表に加えます．
記号表はリンク時にも使うので，アセンブラは記号表をオブジェクトファイルに埋め込みます．
最終的に，記号表の情報を使って，<strong>ラベルをアドレスに変換</strong>します．</li>
<li>例えば，上記の例ではラベル<code>x</code>を記号表で管理して，最終的にアドレス<code>0x4010</code>に変換しています．
<ul>
<li><code>sym-main.s</code>の <code>movl x(%rip), %eax</code> ではラベル<code>x</code>が登場するので，
記号表に加えられます．<code>sym-main.s</code>中には定義が無いので，
<code>nm</code>コマンドで記号表を見ると「<code>x</code>は未定義 (<code>❶ U x</code>)」となっています．</li>
<li>一方，<code>sym-sub.s</code>中にラベル<code>x</code>の定義があるので，
<code>nm</code>で調べると，「<code>x</code>の(仮の)アドレスは0番地 ❷」と表示されます．</li>
<li><code>sym-main.o</code>と<code>sym-sub.o</code>をリンクした<code>a.out</code>を調べると，
「<code>x</code>のアドレスは0x4010番地 ❸」となってます．</li>
<li><code>objdump -D</code>で(<code>.data</code>セクションも含めて)逆アセンブルすると，
<code>x</code>のアドレスは確かに❹<code>0x4010</code>番地となっていて，
<code>movl x(%rip), %eax</code>中のラベル<code>x</code>は相対アドレス❹<code>0x2EE1</code>に
なっています(❺ 0x4010 - ❻ 0x112F = ❼ 0x2EE1)．</li>
</ul>
</li>
</ul>
<h3 id="バイナリ形式として出力"><a class="header" href="#バイナリ形式として出力">バイナリ形式として出力</a></h3>
<ul>
<li>ここまでの処理で，アセンブラはセクション別に2進数のバイト列を生成しています．</li>
<li>アセンブラはこれらのバイト列を<strong>バイナリ形式</strong>のフォーマットに従って
ファイルに出力します．</li>
<li>本書の範囲ではバイナリ形式の詳細を知る必要はありませんが，
以下でELFバイナリ形式の全体の構造だけ説明します．
この知識がないと<code>readelf</code>コマンドを使う際に「ヘッダが3種類ある」と混乱するからです．</li>
</ul>
<h4 id="elfバイナリ形式の構造"><a class="header" href="#elfバイナリ形式の構造">ELFバイナリ形式の構造</a></h4>
<ul>
<li>ELFには3種類のヘッダがあります</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>ヘッダの種類</th><th>表示コマンド</th><th>説明</th></tr></thead><tbody>
<tr><td>ELFヘッダ</td><td><code>readelf -h</code></td><td>ELFファイル全体の目次とメタ情報．必ずファイル先頭に存在</td></tr>
<tr><td>セクションヘッダ</td><td><code>readelf -S</code></td><td>セクションの目次</td></tr>
<tr><td>プログラムヘッダ</td><td><code>readelf -l</code></td><td>セグメントの目次</td></tr>
</tbody></table>
</div><br/>
<img src="figs/elf-header.svg" height="400px" id="fig:elf-header">
<ul>
<li><strong>ELFのセクション</strong>はリンクのための処理の単位です．</li>
<li><strong>ELFのセグメント</strong>は複数のセクションが1つになったもので，
実行時にメモリにロードするための処理の単位です．
<ul>
<li>セクションと区別するために，「セグメント」という異なる名前が付いているがかえって紛らわしい．</li>
</ul>
</li>
<li>ELFヘッダ以外は，配置する場所や順番に決まりはないです．
(セクションヘッダは(ヘッダという名前なのに)ファイルの最後に配置されることが多いです)．
セクションヘッダとプログラムヘッダの位置(オフセット)は
ELFヘッダ中に書かれています．</li>
</ul>
<details>
<summary>
ELFとDWARF
</summary>
<p>バイナリ形式 ELF は executable linkage format の略です．
「北欧神話でおなじみのエルフ(ELF)と来ればドワーフ(DWARF)も欲しいでしょ」
というダジャレで，
(元々はELF形式のために)DWARFという名前のデバッグ情報形式が生まれたようです．</p>
</details>
<h2 id="gnuアセンブラの文法"><a class="header" href="#gnuアセンブラの文法">GNUアセンブラの文法</a></h2>
<h3 id="文"><a class="header" href="#文">文</a></h3>
<img src="figs/gas-stmt.svg" height="120px" id="fig:gas-stmt">
<ul>
<li>
<p>GNUアセンブラの<strong>文</strong>(statement)はアセンブリコードの構成要素であり，
上記の6つのいずれもが1つの文になります．</p>
</li>
<li>
<p>文は改行かセミコロン<code>;</code>で区切ります．</p>
<ul>
<li>
<p>セミコロンで区切れば，複数の文を1行に書いて良いです．
以下はどちらでもOKです</p>
<pre><code class="language-x86asmatt">pushq %rbp
movq %rsp, %rbp
</code></pre>
<pre><code class="language-x86asmatt">pushq %rbp; movq %rsp, %rbp
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="コメント"><a class="header" href="#コメント">コメント</a></h3>
<ul>
<li>
<p>GNUアセンブラのコメントは(C言語と同様に)プログラムのメモ書きです．
アセンブラは単に無視します．</p>
</li>
<li>
<p>行コメント: シャープ記号<code>#</code>から行末までがコメントになります</p>
<pre><code class="language-x86asmatt"># これは行コメントです
</code></pre>
<blockquote>
<p>注: 行コメントに使う記号はアーキテクチャ依存です．
例えば，x86-64は<code>#</code>ですが，ARMは<code>@</code>，H8は<code>;</code>，SPARCは<code>!</code>です．</p>
</blockquote>
</li>
<li>
<p>ブロックコメント: C言語と同じで<code>/*</code>から<code>*/</code>までがコメントです．
C言語と同様にブロックは入れ子禁止です(ブロックコメントの中にブロックコメントは書けません)</p>
<pre><code class="language-x86asmatt">/* これはブロックコメントです．
   複数行でもOKです           */
</code></pre>
</li>
<li>
<p>入れ子のコメントを書くには，C前処理命令 <code>#if 0</code>と<code>#endif</code>を使います．</p>
<ul>
<li>ただし，ファイル拡張子を(大文字の)<code>.S</code>にする必要があります．</li>
<li>拡張子を<code>.S</code>にするとC前処理が実行されるので，<code>#define</code>や<code>#include</code>も使えます．</li>
</ul>
<pre><code>#if 0
これはC前処理命令を使ったコメントです．
これは入れ子にできます．
#endif
</code></pre>
</li>
</ul>
<h3 id="定数"><a class="header" href="#定数">定数</a></h3>
<div class="table-wrapper"><table><thead><tr><th>種類</th><th>説明</th><th>例</th></tr></thead><tbody>
<tr><td>10進数定数</td><td><code>0</code>で始まらない</td><td><code>pushq $74</code></td></tr>
<tr><td>16進数定数</td><td><code>0x</code>か<code>0X</code>で始まる</td><td><code>pushq $0x4A</code></td></tr>
<tr><td>8進数定数</td><td><code>0</code>で始まる</td><td><code>pushq $0112</code></td></tr>
<tr><td>2進数定数</td><td><code>0b</code>か<code>0B</code>で始まる</td><td><code>pushq $0b01001010</code></td></tr>
<tr><td rowspan="3">文字定数</td><td><code>'</code>(クオート)で始まる</td><td><code>pushq $'J</code></td></tr>
<tr><td><code>'</code>(クオート)で囲む</td><td><code>pushq $'J'</code></td></tr>
<tr><td><code>\</code>バックスラッシュ<br/>でエスケープ可</td><td><code>pushq $'\n</code></td></tr>
<tr><td>文字列定数</td><td><code>"</code>(ダブルクオート)で囲む</td><td><code>.string "Hello\n"</code></td></tr>
</tbody></table>
</div>  
<ul>
<li>上の例の最初の4つの定数は全部，値が同じです</li>
<li>GNUアセンブラでは文字定数の値は<a href="./4-data.html#ASCII">ASCIIコード</a>です．
上の例では，文字<code>'J'</code>の値は<code>74</code>です．</li>
<li>バックスラッシュでエスケープできる文字は，
<code>\b</code>, <code>\f</code>, <code>\n</code>, <code>\r</code>, <code>\t</code>,  <code>\&quot;</code>, <code>\\</code> です．
また<code>\123</code>は8進数，<code>\x4F</code>は16進数で指定した文字コードになります．</li>
<li>文字列定数では，<code>.string</code>と<code>.asciz</code>は自動的にヌル文字終端しますが，
<code>.ascii</code>はヌル文字終端しません(必要なら明示的に<code>\0</code>と書く必要があります)．
文字列定数は即値や変位には使えません．</li>
</ul>
<h3 id="式"><a class="header" href="#式">式</a></h3>
<pre><code class="language-x86asmatt">leaq main+10(%rip), %rax # 加算
movq $1&lt;&lt;12, %rax        # 左シフト
movq $1024*1024, %rax    # 乗算
</code></pre>
<ul>
<li>
<p>定数やラベルを書ける場所 (即値や変位)には<strong>式</strong>を書けます．</p>
</li>
<li>
<p>ただし，式には静的に(アセンブル時に)計算できるものだけが書けます．</p>
<ul>
<li>レジスタやメモリの値は参照できません．</li>
</ul>
</li>
<li>
<p>上の例では加算，左シフト，乗算を使った例です．</p>
</li>
<li>
<p>単項演算子</p>
</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>演算子</th><th>意味</th></tr></thead><tbody>
<tr><td><code>-</code></td><td>2の補数による負数</td></tr>
<tr><td><code>~</code></td><td>ビットごとの反転 (1の補数)</td></tr>
</tbody></table>
</div>
<ul>
<li>2項演算子</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>演算子</th><th>意味</th></tr></thead><tbody>
<tr><td><code>*</code></td><td>乗算</td></tr>
<tr><td><code>/</code></td><td>除算</td></tr>
<tr><td><code>%</code></td><td>剰余</td></tr>
<tr><td><code>&lt;&lt;</code></td><td>左シフト</td></tr>
<tr><td><code>&gt;&gt;</code></td><td>右シフト</td></tr>
</tbody></table>
</div><br/>
<div class="table-wrapper"><table><thead><tr><th>演算子</th><th>意味</th></tr></thead><tbody>
<tr><td><code>|</code></td><td>ビットOR</td></tr>
<tr><td><code>&amp;</code></td><td>ビットAND</td></tr>
<tr><td><code>^</code></td><td>ビットXOR</td></tr>
<tr><td><code>!</code></td><td>ビットOR NOT (a</td></tr>
</tbody></table>
</div><br/>
<div class="table-wrapper"><table><thead><tr><th>演算子</th><th>意味</th></tr></thead><tbody>
<tr><td><code>+</code></td><td>加算</td></tr>
<tr><td><code>-</code></td><td>減算</td></tr>
<tr><td><code>==</code></td><td>等しい</td></tr>
<tr><td><code>!=</code></td><td>等しくない</td></tr>
<tr><td><code>&lt;&gt;</code></td><td>等しくない</td></tr>
<tr><td><code>&lt;</code></td><td>小さい</td></tr>
<tr><td><code>&gt;</code></td><td>大きい</td></tr>
<tr><td><code>&lt;=</code></td><td>以下</td></tr>
<tr><td><code>&gt;=</code></td><td>以上</td></tr>
</tbody></table>
</div><br/>
<div class="table-wrapper"><table><thead><tr><th>演算子</th><th>意味</th></tr></thead><tbody>
<tr><td><code>&amp;&amp;</code></td><td>論理AND</td></tr>
<tr><td><code>||</code></td><td>論理OR</td></tr>
</tbody></table>
</div>
<ul>
<li>一番上が最も優先度が高く，順番に下に行くほど優先度が下がります．</li>
</ul>
<!--
- `+`と`-`以外はリンクで変化しない値でなければいけません．
-->
<ul>
<li>述語演算子は，真の時は<code>-1</code> (つまり全ビットが1)，負の時は<code>0</code> (つまり全ビットが0)を返します．</li>
<li>2023/9: <code>=</code>が入ってる演算子を使うと，
<code>foo.s:9: Error: invalid character '=' in operand 1</code>というエラーがでます．なぜなんだぜ</li>
</ul>
<h2 id="ラベルと識別子"><a class="header" href="#ラベルと識別子">ラベルと識別子</a></h2>
<p>PICの場合，絶対アドレスを得る方法はないのか
(動的に LEA命令を使わず)</p>
<h3 id="ロケーションカウンタ"><a class="header" href="#ロケーションカウンタ">ロケーションカウンタ</a></h3>
<h3 id="シンボル"><a class="header" href="#シンボル">シンボル</a></h3>
<h3 id="ラベル"><a class="header" href="#ラベル">ラベル</a></h3>
<h3 id="特別なドットラベル-"><a class="header" href="#特別なドットラベル-">特別なドットラベル <code>.</code></a></h3>
<h2 id="アセンブラ命令-1"><a class="header" href="#アセンブラ命令-1">アセンブラ命令</a></h2>
<h3 id="セクション指定"><a class="header" href="#セクション指定">セクション指定</a></h3>
<h3 id="データ配置"><a class="header" href="#データ配置">データ配置</a></h3>
<h3 id="出力アドレス調整-アラインメント"><a class="header" href="#出力アドレス調整-アラインメント">出力アドレス調整 (アラインメント)</a></h3>
<h4 id="ロケーションカウンタ-1"><a class="header" href="#ロケーションカウンタ-1">ロケーションカウンタ</a></h4>
<h3 id="シンボル情報"><a class="header" href="#シンボル情報">シンボル情報</a></h3>
<h3 id="マクロ"><a class="header" href="#マクロ">マクロ</a></h3>
<h2 id="att形式とintel形式"><a class="header" href="#att形式とintel形式">AT&amp;T形式とIntel形式</a></h2>

		    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="6-inst.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="8-inline.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="6-inst.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="8-inline.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/pagetoc.js"></script>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F3GVG4RZLD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F3GVG4RZLD');
</script>

    </div>
    </body>
</html>
